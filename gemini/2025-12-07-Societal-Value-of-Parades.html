import React, { useState, useRef, useEffect } from 'react';
import { 
  BookOpen, 
  Shield, 
  Crown, 
  Users, 
  PartyPopper, 
  ShoppingBag, 
  Flag, 
  Trophy, 
  Heart,
  ChevronRight,
  ChevronDown,
  Maximize2,
  Minimize2,
  Menu,
  X,
  Lightbulb,
  Brain,
  Sparkles,
  MessageSquare,
  Wand2,
  Loader2,
  Send
} from 'lucide-react';

// --- Gemini API Configuration ---
const apiKey = ""; // System provides key at runtime

const callGemini = async (prompt, systemInstruction = "") => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] }
        }),
      }
    );

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No insights found.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "The spirits are quiet (API Error). Please try again.";
  }
};

// --- Data Structure ---

const sections = [
  {
    id: 'intro',
    title: 'The War Heuristic',
    icon: <Brain className="w-6 h-6 text-pink-400" />,
    color: 'border-pink-500',
    summary: 'Why we think "Parades = War" and why that is a cognitive bias.',
    content: [
      {
        heading: 'The Dunning-Kruger Effect',
        text: 'Learning a single fact ("Parades have Roman military roots") creates a false sense of mastery. This is the "Peak of Mount Stupid." Real expertise reveals that parades have multiple, non-military origins.',
        type: 'concept'
      },
      {
        heading: 'The Genealogical Fallacy',
        text: 'Just because something *started* as X does not mean it *is* X today. A wedding ring may have roots in ownership chains, but it symbolizes love today. Similarly, a parade using military formation does not inherently promote war.',
        type: 'fallacy'
      }
    ]
  },
  {
    id: 'babylon',
    title: 'Babylon: Cosmic Repair',
    icon: <Crown className="w-6 h-6 text-yellow-400" />,
    color: 'border-yellow-500',
    summary: 'The earliest parades were about humility, not pride.',
    content: [
      {
        heading: 'The Akitu Festival',
        text: 'In Ancient Babylon, the New Year parade wasn\'t about showing off power. It was about "World Maintenance." The King was stripped of his regalia, slapped by a priest, and forced to kneel to ensure he hadn\'t been a tyrant.',
        type: 'history'
      },
      {
        heading: 'Key Insight',
        text: 'Military Parade = "Look at our power to destroy." \nReligious Procession = "Look at our need for protection."',
        type: 'insight'
      }
    ]
  },
  {
    id: 'classical',
    title: 'Rome vs. Greece',
    icon: <Shield className="w-6 h-6 text-red-400" />,
    color: 'border-red-500',
    summary: 'Two paths: The Roman Triumph (War) vs. The Greek Panathenaia (Civic).',
    content: [
      {
        heading: 'The Roman Triumph',
        text: 'This is the source of the "War Heuristic." A general parading captives. But even here, a slave whispered "Remember you are mortal" to prevent hubris.',
        type: 'history'
      },
      {
        heading: 'The Greek Approach',
        text: 'The Panathenaia was a diagram of democracy. Weavers, potters, and elders marched. It was about defining the city, not conquering others.',
        type: 'history'
      }
    ]
  },
  {
    id: 'medieval',
    title: 'Medieval Guilds',
    icon: <Users className="w-6 h-6 text-blue-400" />,
    color: 'border-blue-500',
    summary: 'When workers and merchants took over the streets.',
    content: [
      {
        heading: 'Mystery Plays',
        text: 'Labor unions (Guilds) built "pageant wagons" to tell stories. Shipwrights built the Ark; Bakers served the Last Supper. It was a display of *labor*, not weapons.',
        type: 'history'
      },
      {
        heading: 'Civic Pride',
        text: 'This tradition leads directly to modern commercial parades. It celebrates the "Bourgeoisie"—power based on trade and law, not the sword.',
        type: 'insight'
      }
    ]
  },
  {
    id: 'carnival',
    title: 'Carnival & Mardi Gras',
    icon: <PartyPopper className="w-6 h-6 text-purple-400" />,
    color: 'border-purple-500',
    summary: 'The "Safety Valve" that prevents war through mockery.',
    content: [
      {
        heading: 'Ritual of Inversion',
        text: 'In Carnival, the poor become Kings and Kings become fools. It is the direct opposite of a military parade (which reinforces rank). It releases social tension ("Safety Valve").',
        type: 'concept'
      },
      {
        heading: 'Mardi Gras Indians',
        text: 'Black communities in New Orleans transformed gang violence into aesthetic competition. "Who is the prettiest?" replaced "Who is the toughest?"',
        type: 'history'
      }
    ]
  },
  {
    id: 'commercial',
    title: 'Macy\'s & Immigrants',
    icon: <ShoppingBag className="w-6 h-6 text-orange-400" />,
    color: 'border-orange-500',
    summary: 'A massive assimilation machine for the American Dream.',
    content: [
      {
        heading: 'Immigrant Origins',
        text: 'Started by European employees who missed their old-world festivals. It helped them feel "American" while keeping their traditions.',
        type: 'history'
      },
      {
        heading: 'Balloons vs. Zoo',
        text: 'In 1927, they switched from live bears (dominion over nature) to giant balloons (fantasy/innocence). Balloons are anti-military: soft, whimsical, and vulnerable.',
        type: 'insight'
      }
    ]
  },
  {
    id: 'protest',
    title: 'Protest: Peace Weapons',
    icon: <Flag className="w-6 h-6 text-green-400" />,
    color: 'border-green-500',
    summary: 'Using military discipline to demand non-violent change.',
    content: [
      {
        heading: 'Suffragettes (1913)',
        text: 'Women marched in military-style battalions to prove they had the "discipline" for voting. They appropriated the form of war to demand rights.',
        type: 'history'
      },
      {
        heading: 'The Salt March',
        text: 'Gandhi used the procession to dismantle an empire. Walking 240 miles to make salt showed that you can fight without weapons. "Satyagraha" (Truth-force).',
        type: 'history'
      }
    ]
  },
  {
    id: 'sports',
    title: 'Sports: Modern Gladiators?',
    icon: <Trophy className="w-6 h-6 text-cyan-400" />,
    color: 'border-cyan-500',
    summary: 'Are football players gladiators? Yes and No.',
    content: [
      {
        heading: 'The Valid Fear',
        text: 'Like gladiators, players risk their bodies (CTE) for mass entertainment. The "Modern Gladiator" critique is valid regarding injury and commodification.',
        type: 'concept'
      },
      {
        heading: 'The Sociological Difference',
        text: 'However, sports act as a "Ritualization of Aggression." It simulates war so we don\'t have to actually do it. It channels tribalism into a game with rules.',
        type: 'insight'
      }
    ]
  }
];

// --- AI Components ---

const RitualDecoder = ({ onClose }) => {
  const [input, setInput] = useState('');
  const [result, setResult] = useState('');
  const [loading, setLoading] = useState(false);

  const handleAnalyze = async () => {
    if (!input.trim()) return;
    setLoading(true);
    setResult('');

    const systemPrompt = `You are a sociological expert explaining rituals to someone with ADHD. 
    Analyze the user's event using the concepts of: 'Safety Valve' (releasing tension), 'Civic Display' (belonging), or 'Inversion' (flipping roles).
    Keep it punchy, use 3 bullet points, and avoid academic jargon. Use emojis.`;

    const userPrompt = `Analyze the societal value of this event: "${input}". Is it a form of parade or ritual?`;

    const response = await callGemini(userPrompt, systemPrompt);
    setResult(response);
    setLoading(false);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
      <div className="bg-gray-900 border border-purple-500/50 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-fade-in-up">
        <div className="p-6 bg-gradient-to-r from-gray-900 to-purple-900/20">
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 flex items-center gap-2">
              <Sparkles className="text-purple-400" size={20} />
              ✨ Ritual Decoder
            </h3>
            <button onClick={onClose} className="text-gray-400 hover:text-white">
              <X size={20} />
            </button>
          </div>
          <p className="text-gray-400 text-sm mb-4">
            Confused about a modern event? Type it in (e.g., "Comic-Con", "Black Friday", "The Super Bowl") to see its hidden societal function.
          </p>
          
          <div className="relative">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Enter an event..."
              className="w-full bg-gray-800 border border-gray-700 rounded-lg py-3 px-4 pr-12 text-white focus:outline-none focus:border-purple-500 transition-colors"
              onKeyDown={(e) => e.key === 'Enter' && handleAnalyze()}
            />
            <button 
              onClick={handleAnalyze}
              disabled={loading || !input.trim()}
              className="absolute right-2 top-2 p-1.5 bg-purple-600 rounded-md text-white hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {loading ? <Loader2 size={18} className="animate-spin" /> : <Send size={18} />}
            </button>
          </div>
        </div>

        {result && (
          <div className="p-6 border-t border-gray-800 bg-gray-800/30 max-h-64 overflow-y-auto">
             <div className="prose prose-invert prose-sm">
               <div className="whitespace-pre-wrap leading-relaxed text-gray-200">{result}</div>
             </div>
          </div>
        )}
      </div>
    </div>
  );
};

const ContentCard = ({ block, idx, activeSection, expandedCards, toggleCard }) => {
  const [aiExplanation, setAiExplanation] = useState(null);
  const [loadingAi, setLoadingAi] = useState(false);

  const isExpanded = expandedCards[`${activeSection}-${idx}`];
  const isKeyInsight = block.type === 'insight';

  const handleSimplify = async (e) => {
    e.stopPropagation();
    if (aiExplanation) {
      setAiExplanation(null); // Toggle off
      return;
    }
    
    setLoadingAi(true);
    const systemPrompt = "You are a helpful tutor for someone with ADHD. Simplify the following text into one clear, memorable sentence or analogy. Be brief.";
    const response = await callGemini(`Simplify this concept: ${block.heading} - ${block.text}`, systemPrompt);
    setAiExplanation(response);
    setLoadingAi(false);
  };

  return (
    <div 
      className={`
        transition-all duration-300 rounded-xl border relative
        ${isKeyInsight ? 'bg-gradient-to-br from-gray-800 to-gray-900 border-purple-500/30' : 'bg-gray-800/40 border-gray-800'}
      `}
    >
      <button
        onClick={() => toggleCard(activeSection, idx)}
        className="w-full flex items-center justify-between p-4 text-left group"
      >
        <div className="flex items-center gap-3">
          <span className={`
            w-1.5 h-1.5 rounded-full 
            ${isKeyInsight ? 'bg-purple-400' : 'bg-gray-500'}
            group-hover:scale-150 transition-transform
          `}/>
          <h3 className={`font-semibold ${isKeyInsight ? 'text-purple-200' : 'text-gray-200'}`}>
            {block.heading}
          </h3>
        </div>
        <div className="flex items-center gap-3">
          {/* Simplify Button */}
           <div 
            role="button"
            onClick={handleSimplify}
            className={`
              p-1.5 rounded-full transition-all duration-300 z-10
              ${loadingAi ? 'bg-purple-500/20 text-purple-300' : 'hover:bg-purple-500/20 text-gray-500 hover:text-purple-300'}
              ${aiExplanation ? 'bg-purple-500/20 text-purple-300' : ''}
            `}
            title="✨ Simplify with AI"
          >
            {loadingAi ? <Loader2 size={16} className="animate-spin" /> : <Wand2 size={16} />}
          </div>
          
          {isExpanded ? 
            <ChevronDown size={18} className="text-gray-500" /> : 
            <ChevronRight size={18} className="text-gray-500" />
          }
        </div>
      </button>

      <div className={`
        overflow-hidden transition-all duration-300
        ${isExpanded ? 'max-h-[500px] opacity-100' : 'max-h-0 opacity-0'}
      `}>
        <div className="p-4 pt-0">
          {aiExplanation && (
             <div className="mb-4 p-3 rounded-lg bg-purple-900/20 border border-purple-500/20 text-purple-200 text-sm flex gap-2 animate-fade-in">
               <Sparkles size={16} className="shrink-0 mt-0.5" />
               <div>{aiExplanation}</div>
             </div>
          )}
          <div className="text-gray-300 leading-relaxed text-base md:text-lg">
            {block.text}
          </div>
        </div>
      </div>
    </div>
  );
};

export default function ParadeExplorer() {
  const [activeSection, setActiveSection] = useState(0);
  const [focusMode, setFocusMode] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [expandedCards, setExpandedCards] = useState({});
  const [showDecoder, setShowDecoder] = useState(false);

  // Toggle detail view for specific content blocks
  const toggleCard = (sectionIndex, contentIndex) => {
    const key = `${sectionIndex}-${contentIndex}`;
    setExpandedCards(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  const handleNext = () => {
    if (activeSection < sections.length - 1) {
      setActiveSection(prev => prev + 1);
      window.scrollTo(0, 0);
    }
  };

  const handlePrev = () => {
    if (activeSection > 0) {
      setActiveSection(prev => prev - 1);
      window.scrollTo(0, 0);
    }
  };

  const currentData = sections[activeSection];
  const progress = ((activeSection + 1) / sections.length) * 100;

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-sans selection:bg-purple-500 selection:text-white flex overflow-hidden">
      
      {/* AI Modal */}
      {showDecoder && <RitualDecoder onClose={() => setShowDecoder(false)} />}

      {/* Mobile Sidebar Toggle */}
      <button 
        onClick={() => setSidebarOpen(!sidebarOpen)}
        className="md:hidden fixed top-4 right-4 z-50 p-2 bg-gray-800 rounded-full shadow-lg border border-gray-700"
      >
        {sidebarOpen ? <X size={20} /> : <Menu size={20} />}
      </button>

      {/* Sidebar Navigation */}
      <nav className={`
        fixed md:relative z-40 h-full w-64 bg-gray-950 border-r border-gray-800 flex flex-col transition-transform duration-300
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
        ${focusMode ? 'md:hidden' : 'md:flex'}
      `}>
        <div className="p-6 border-b border-gray-800">
          <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
            Parade Roots
          </h1>
          <p className="text-xs text-gray-500 mt-1">Societal Value Deep Dive</p>
        </div>

        <div className="flex-1 overflow-y-auto py-4">
          {sections.map((section, idx) => (
            <button
              key={section.id}
              onClick={() => {
                setActiveSection(idx);
                if (window.innerWidth < 768) setSidebarOpen(false);
              }}
              className={`w-full px-6 py-3 flex items-center gap-3 transition-colors text-left
                ${activeSection === idx ? 'bg-gray-800 border-r-2 border-purple-500 text-white' : 'text-gray-400 hover:bg-gray-900 hover:text-gray-200'}
              `}
            >
              <div className={`${activeSection === idx ? 'opacity-100' : 'opacity-50'}`}>
                {section.icon}
              </div>
              <span className="text-sm font-medium">{section.title}</span>
            </button>
          ))}
        </div>

        <div className="p-4 border-t border-gray-800">
          <div className="flex items-center justify-between text-xs text-gray-500 mb-2">
            <span>Progress</span>
            <span>{Math.round(progress)}%</span>
          </div>
          <div className="h-1 bg-gray-800 rounded-full overflow-hidden">
            <div 
              className="h-full bg-purple-500 transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="flex-1 h-screen overflow-y-auto relative scroll-smooth">
        
        {/* Top Bar */}
        <div className="sticky top-0 z-30 bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 px-6 py-4 flex flex-wrap gap-4 justify-between items-center">
          <div className="flex items-center gap-2 text-sm text-gray-400">
            <span className="bg-gray-800 px-2 py-1 rounded text-xs font-mono">
              {activeSection + 1} / {sections.length}
            </span>
            <span className="hidden sm:inline"> | {currentData.title}</span>
          </div>

          <div className="flex items-center gap-2">
             <button
              onClick={() => setShowDecoder(true)}
              className="flex items-center gap-2 text-xs font-bold text-purple-200 hover:text-white px-3 py-1.5 rounded-full bg-purple-900/30 hover:bg-purple-800/50 border border-purple-500/30 transition-all shadow-[0_0_10px_rgba(168,85,247,0.1)]"
            >
              <Sparkles size={14} className="text-purple-400" />
              <span>✨ Ritual Decoder</span>
            </button>

            <button
              onClick={() => setFocusMode(!focusMode)}
              className="flex items-center gap-2 text-xs font-medium text-gray-400 hover:text-white px-3 py-1.5 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors"
            >
              {focusMode ? <Minimize2 size={14} /> : <Maximize2 size={14} />}
              <span className="hidden sm:inline">{focusMode ? 'Exit Focus' : 'Focus Mode'}</span>
            </button>
          </div>
        </div>

        <div className="max-w-3xl mx-auto px-6 py-10 pb-32">
          
          {/* Section Header */}
          <header className="mb-8 animate-fade-in">
            <div className={`inline-flex p-3 rounded-2xl bg-gray-800 border ${currentData.color} mb-4 shadow-[0_0_15px_rgba(0,0,0,0.3)]`}>
              {currentData.icon}
            </div>
            <h2 className="text-3xl md:text-4xl font-bold mb-3 tracking-tight">
              {currentData.title}
            </h2>
            <p className="text-lg text-gray-400 leading-relaxed border-l-2 border-gray-700 pl-4 italic">
              {currentData.summary}
            </p>
          </header>

          {/* Dynamic Content Blocks */}
          <div className="space-y-4">
            {currentData.content.map((block, idx) => (
              <ContentCard 
                key={idx}
                block={block}
                idx={idx}
                activeSection={activeSection}
                expandedCards={expandedCards}
                toggleCard={toggleCard}
              />
            ))}
          </div>

          {/* Action Area */}
          <div className="mt-12 flex items-center justify-between border-t border-gray-800 pt-8">
            <button
              onClick={handlePrev}
              disabled={activeSection === 0}
              className={`
                flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors
                ${activeSection === 0 ? 'text-gray-600 cursor-not-allowed' : 'text-gray-400 hover:text-white hover:bg-gray-800'}
              `}
            >
              Previous
            </button>

            {activeSection === sections.length - 1 ? (
               <div className="flex items-center gap-2 text-green-400 font-bold animate-pulse">
                 <Heart size={18} fill="currentColor" />
                 <span>Journey Complete</span>
               </div>
            ) : (
              <button
                onClick={handleNext}
                className="group flex items-center gap-2 px-6 py-3 rounded-lg bg-gray-100 text-gray-900 font-bold hover:bg-white hover:scale-105 transition-all shadow-lg shadow-purple-900/20"
              >
                Next Section
                <ChevronRight size={18} className="group-hover:translate-x-1 transition-transform" />
              </button>
            )}
          </div>

        </div>
      </main>
    </div>
  );
}
